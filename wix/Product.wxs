<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <Package Name="FastSearch MCP" 
           Manufacturer="FastSearch" 
           Version="1.0.0" 
           UpgradeCode="YOUR-UPGRADE-CODE-HERE"
           Compressed="yes">
    
    <MajorUpgrade DowngradeErrorMessage="A newer version of FastSearch MCP is already installed." />
    <MediaTemplate EmbedCab="yes" />
    <UIRef Id="WixUI_InstallDir" />
    <WixVariable Id="WixUILicenseRtf" Value="license.rtf" />
    <WixVariable Id="WixUIBannerBmp" Value="banner.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="dialog.bmp" />
    
    <!-- Set installation directory -->
    <StandardDirectory Id="ProgramFilesFolder">
      <Directory Id="INSTALLFOLDER" Name="FastSearch MCP" />
    </StandardDirectory>

    <!-- Application files -->
    <Feature Id="ProductFeature" Title="FastSearch MCP" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="ServiceComponents" />
    </Feature>

    <!-- UI Customization -->
    <UI>
      <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
      <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch FastSearch Service" />
      <Property Id="WixShellExecTarget" Value="[#FastSearchMCPBridgeExe]" />
      
      <Publish Dialog="ExitDialog" 
               Control="Finish" 
               Event="DoAction" 
               Value="LaunchApplication" 
               Order="1">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
    </UI>

    <!-- Custom Actions -->
    <CustomAction Id="LaunchApplication" 
                  BinaryKey="WixCA" 
                  DllEntry="WixShellExec" 
                  Impersonate="yes" />
  </Package>

  <!-- Files -->
  <Fragment>
    <ComponentGroup Id="ProductComponents">
      <!-- Bridge Executable -->
      <Component Id="BridgeExe" Directory="INSTALLFOLDER" Guid="*">
        <File Id="FastSearchMCPBridgeExe" 
              Source="$(var.SolutionDir)target\release\fastsearch-mcp-bridge.exe" 
              KeyPath="yes" />
        <Shortcut Id="startmenuBridge" 
                 Directory="ProgramMenuFolder" 
                 Name="FastSearch MCP Bridge" 
                 WorkingDirectory="INSTALLFOLDER"
                 Advertise="yes" />
      </Component>

      <!-- Service Executable -->
      <Component Id="ServiceExe" Directory="INSTALLFOLDER" Guid="*">
        <File Id="FastSearchServiceExe" 
              Source="$(var.SolutionDir)target\release\fastsearch.exe" 
              KeyPath="yes" />
      </Component>

      <!-- Uninstall Shortcut -->
      <Component Id="UninstallShortcut" Directory="INSTALLFOLDER" Guid="*">
        <Shortcut Id="UninstallProduct" 
                 Directory="ProgramMenuFolder" 
                 Name="Uninstall FastSearch MCP"
                 Target="[System64Folder]msiexec.exe"
                 Arguments="/x [ProductCode]"
                 Description="Uninstalls FastSearch MCP" />
        <RemoveFolder Id="ProgramMenuFolder" On="uninstall" />
        <RegistryValue Root="HKCU" 
                      Key="Software\FastSearchMCP" 
                      Name="installed" 
                      Type="integer" 
                      Value="1" 
                      KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- Windows Service Installation -->
  <Fragment>
    <ComponentGroup Id="ServiceComponents">
      <Component Id="ServiceInstall" Directory="INSTALLFOLDER" Guid="*">
        <File Id="FastSearchService" 
              Source="$(var.SolutionDir)target\release\fastsearch.exe" 
              KeyPath="yes" />
        <ServiceInstall Id="FastSearchService" 
                       Name="FastSearchService" 
                       DisplayName="FastSearch MCP Service"
                       Description="Provides lightning-fast file search using NTFS MFT"
                       Start="auto" 
                       Type="ownProcess"
                       Vital="yes"
                       ErrorControl="normal"
                       Account="LocalSystem"
                       Arguments="--run-as-service"
                       Interactive="no">
          <ServiceDependency Id="tcpip" />
        </ServiceInstall>
        <ServiceControl Id="StartService" 
                       Name="FastSearchService" 
                       Start="install" 
                       Stop="both" 
                       Remove="uninstall" 
                       Wait="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>
</Wix>
